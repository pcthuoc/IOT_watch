{% extends "layouts/base.html" %}

{% block title %} Danh s√°ch File √Çm Thanh {% endblock %}

{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<main class="content">

    {% include 'includes/navigation.html' %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center py-4">
        <div class="d-block mb-4 mb-md-0">
            <nav aria-label="breadcrumb" class="d-none d-md-inline-block">
                <h2 class="h4 m-0">Danh s√°ch c√°c l·ªùi nh·∫Øc</h2>
            </nav>
        </div>
        <div class="btn-group">
            <button class="btn btn-secondary" type="button" data-toggle="modal" data-target="#editAddModal">
                Th√™m nh·∫Øc nh·ªü
            </button>
        </div>
    </div>


    <div class="card card-body border-light shadow-sm table-wrapper table-responsive pt-0">
        <div class="table-responsive">
            <table class="table text-center align-middle">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Th·ªùi gian</th>
                        <th>N·ªôi dung</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>T√πy ch·ªçn</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reminder in reminders %}
                    <tr>
                        <td>{{ forloop.counter|add:page_obj.start_index|add:-1 }}</td>
                        <td>{{ reminder.remind_at|date:"Y-m-d H:i:s" }}</td>
                        <td>{{ reminder.message }}</td>
                        <td>
                            {% if reminder.status == 'Completed' %}
                            <span class="font-weight-bold text-success">{{ reminder.get_status_display }}</span>
                            {% elif reminder.status == 'Pending' %}
                            <span class="font-weight-bold text-warning">{{ reminder.get_status_display }}</span>
                            {% elif reminder.status == 'Ignored' %}
                            <span class="font-weight-bold text-danger">{{ reminder.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-link text-dark dropdown-toggle dropdown-toggle-split m-0 p-0"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="icon icon-sm">
                                        <span class="fas fa-ellipsis-h icon-dark"></span>
                                    </span>
                                </button>
                                <div class="dropdown-menu">
                                    <a href="#" class="dropdown-item play-tts" data-message="{{ reminder.message }}">
                                        <span class="fa fa-play"></span> Ph√°t
                                    </a>


                                    <!-- N√∫t ch·ªânh s·ª≠a -->
                                    <button class="dropdown-item text-warning edit-btn" data-id="{{ reminder.id }}"
                                        data-message="{{ reminder.message }}" data-status="{{ reminder.status }}"
                                        data-remind_at="{{ reminder.remind_at|date:'Y-m-d\TH:i' }}" data-toggle="modal"
                                        data-target="#editAddModal">
                                        <span class="fa fa-edit"></span> Ch·ªânh s·ª≠a
                                    </button>
                                    <!-- N√∫t x√≥a -->
                                    <button class="dropdown-item text-danger delete-btn" data-id="{{ reminder.id }}"
                                        data-toggle="modal" data-target="#deleteModal">
                                        <span class="fa fa-trash"></span> X√≥a
                                    </button>
                                </div>
                            </div>
                        </td>


                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6">Kh√¥ng c√≥ l·ªùi nh·∫Øc n√†o.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between mt-3">
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            <!-- Hi·ªÉn th·ªã s·ªë b·∫£n ghi hi·ªán t·∫°i v√† t·ªïng s·ªë b·∫£n ghi -->
            <div class="font-weight-bold small">
                Hi·ªÉn th·ªã <b>{{ page_obj.start_index }}</b> ƒë·∫øn
                <b>{{ page_obj.end_index }}</b> trong t·ªïng s·ªë
                <b>{{ page_obj.paginator.count }}</b> b·∫£n ghi.
            </div>


        </div>

    </div>

    {% include 'includes/footer.html' %}

</main>
<!-- Modal Edit/Add -->
<div class="modal fade" id="editAddModal" tabindex="-1" role="dialog" aria-labelledby="editAddModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAddModalLabel">Th√™m m·ªõi l·ªùi nh·∫Øc</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editAddForm">
                    {% csrf_token %}
                    <input type="hidden" id="reminderId" name="id">
                    <div class="form-group">
                        <label for="message">N·ªôi dung</label>
                        <textarea class="form-control" id="message" name="message" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="status">Tr·∫°ng th√°i</label>
                        <select class="form-control" id="status" name="status" required>
                            <option value="Pending">Ch∆∞a ho√†n th√†nh</option>
                            <option value="Completed">Ho√†n th√†nh</option>
                            <option value="Ignored">B·ªã b·ªè qua</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="remind_at">Th·ªùi gian</label>
                        <input type="datetime-local" class="form-control" id="remind_at" name="remind_at" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="confirmAction">Th√™m m·ªõi</button>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">X√°c nh·∫≠n x√≥a</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªùi nh·∫Øc n√†y v·ªõi ID <strong id="deleteID"></strong> kh√¥ng?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">X√≥a</button>
            </div>
        </div>
    </div>
</div>



{% endblock content %}
{% block javascripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/js/bootstrap.bundle.min.js"></script>
<script>
    const notyf = new Notyf({
        position: { x: 'right', y: 'top' },
        types: [
            {
                type: 'success',
                background: '#4BB543',
                icon: {
                    className: 'fas fa-check',
                    tagName: 'span',
                    color: '#fff'
                },
                dismissible: true
            },
            {
                type: 'error',
                background: '#FA5151',
                icon: {
                    className: 'fas fa-times',
                    tagName: 'span',
                    color: '#fff'
                },
                dismissible: true
            },
            {
                type: 'info',
                background: '#2F86EB',
                icon: {
                    className: 'fas fa-info-circle',
                    tagName: 'span',
                    color: '#fff'
                },
                dismissible: true
            }
        ]
    });

    // K·∫øt n·ªëi WebSocket TTS
    const ttsSocket = new WebSocket("ws://" + window.location.host + "/ws/tts/");

    ttsSocket.onopen = function () {
        console.log("‚úÖ K·∫øt n·ªëi WebSocket TTS th√†nh c√¥ng");
    };

    ttsSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.status === "played") {
            notyf.open({ type: 'success', message: '‚úÖ Chuy·ªÉn ƒë·ªïi th√†nh c√¥ng!' });
        }
    };

    ttsSocket.onclose = function (e) {
        console.log("‚ùå K·∫øt n·ªëi WebSocket TTS ƒë√£ ƒë√≥ng", e);
    };

    ttsSocket.onerror = function (e) {
        console.error("üí• L·ªói WebSocket TTS:", e);
    };
    document.addEventListener("DOMContentLoaded", function () {
        let selectedId = "";

        // Khi nh·∫•n v√†o n√∫t x√≥a, l·∫•y ID c·ªßa l·ªùi nh·∫Øc v√† hi·ªÉn th·ªã trong modal
        $(document).on("click", ".delete-btn", function () {
            selectedId = $(this).data("id");
            $("#deleteID").text(selectedId);  // Hi·ªÉn th·ªã ID trong modal
        });

        // Khi nh·∫•n n√∫t X√≥a trong modal
        $("#confirmDelete").click(function () {
            if (!selectedId) {
                alert("L·ªói: Kh√¥ng c√≥ ID l·ªùi nh·∫Øc ƒë·ªÉ x√≥a!");
                return;
            }

            // G·ª≠i y√™u c·∫ßu x√≥a l·ªùi nh·∫Øc v·ªõi ID ƒë√£ ch·ªçn
            fetch(`/reminder/delete/${selectedId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ƒê√≥ng modal v√† x√≥a class backdrop/modal-open
                        $("#deleteModal").modal("hide");
                        setTimeout(() => {
                            $("body").removeClass("modal-open");
                            $(".modal-backdrop").remove();
                        }, 500);

                        // // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                        // alert(data.message);

                        // Reload trang sau khi x√≥a th√†nh c√¥ng
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        $("#deleteModal").modal("hide");
                        setTimeout(() => {
                            $("body").removeClass("modal-open");
                            $(".modal-backdrop").remove();
                        }, 500);
                        alert(data.message);  // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
                    }
                })
                .catch(error => {
                    console.error("L·ªói:", error);
                    $("body").removeClass("modal-open");
                    $(".modal-backdrop").remove();
                    $("#deleteModal").modal("hide");
                    alert("ƒê√£ x·∫£y ra l·ªói! Vui l√≤ng th·ª≠ l·∫°i.");
                });
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
        let selectedId = "";  // Bi·∫øn l∆∞u ID c·ªßa l·ªùi nh·∫Øc khi ch·ªânh s·ª≠a

        // Khi nh·∫•n v√†o n√∫t Ch·ªânh s·ª≠a, m·ªü modal v√† ƒëi·ªÅn d·ªØ li·ªáu v√†o form
        $(document).on("click", ".edit-btn", function () {
            selectedId = $(this).data("id");  // L∆∞u ID c·ªßa l·ªùi nh·∫Øc
            const message = $(this).data("message");  // L·∫•y n·ªôi dung l·ªùi nh·∫Øc
            const status = $(this).data("status");  // L·∫•y tr·∫°ng th√°i l·ªùi nh·∫Øc
            const remind_at = $(this).data("remind_at");  // L·∫•y th·ªùi gian l·ªùi nh·∫Øc

            // ƒêi·ªÅn d·ªØ li·ªáu v√†o c√°c tr∆∞·ªùng trong form
            $("#reminderId").val(selectedId);
            $("#message").val(message);
            $("#status").val(status);
            $("#remind_at").val(remind_at);

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ v√† h√†nh ƒë·ªông c·ªßa modal
            $("#editAddModalLabel").text("Ch·ªânh s·ª≠a l·ªùi nh·∫Øc");
            $("#confirmAction").text("C·∫≠p nh·∫≠t");

            // M·ªü modal
            $("#editAddModal").modal("show");
        });

        // Khi nh·∫•n v√†o n√∫t "Th√™m nh·∫Øc nh·ªü", m·ªü modal v·ªõi form tr·ªëng
        $(document).on("click", "#addBtn", function () {
            $("#editAddForm")[0].reset();  // ƒê·∫∑t l·∫°i form
            $("#editAddModalLabel").text("Th√™m m·ªõi l·ªùi nh·∫Øc");
            $("#confirmAction").text("Th√™m m·ªõi");
            $("#editAddModal").modal("show");
        });

        // Khi nh·∫•n n√∫t "C·∫≠p nh·∫≠t" ho·∫∑c "Th√™m m·ªõi"
        $("#confirmAction").click(function () {
            const formData = new FormData(document.getElementById("editAddForm"));
            const url = selectedId ? `/reminder/edit/${selectedId}/` : "reminder/add/";  // Ch·ªânh s·ª≠a n·∫øu c√≥ ID, th√™m m·ªõi n·∫øu kh√¥ng

            // G·ª≠i d·ªØ li·ªáu ƒë·∫øn server ƒë·ªÉ c·∫≠p nh·∫≠t ho·∫∑c th√™m m·ªõi
            fetch(url, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        $("#editAddModal").modal("hide");
                        setTimeout(() => location.reload(), 1000);  // T·∫£i l·∫°i trang sau khi th√†nh c√¥ng
                    } else {
                        alert(data.message);  // Th√¥ng b√°o l·ªói n·∫øu c√≥
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("ƒê√£ x·∫£y ra l·ªói, vui l√≤ng th·ª≠ l·∫°i.");
                });
        });
    });


    document.addEventListener('DOMContentLoaded', function () {

        document.querySelectorAll('.play-tts').forEach(el => {
            el.addEventListener('click', function (e) {
                e.preventDefault();

                const message = el.dataset.message;
                const url = `/tts/zalo/?message=${encodeURIComponent(message)}`;

                notyf.open({ type: 'info', message: 'üîä ƒêang chuy·ªÉn ƒë·ªïi vƒÉn b·∫£n th√†nh gi·ªçng n√≥i...' });

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (data.audio_url) {
                            notyf.open({ type: 'success', message: '‚úÖ Chuy·ªÉn ƒë·ªïi th√†nh c√¥ng!' });

                            // Tu·ª≥ ch·ªçn: ph√°t lu√¥n audio
                            const audio = new Audio(data.audio_url);
                            audio.play();
                        } else {
                            notyf.open({ type: 'error', message: `‚ùå ${data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh"}` });
                        }
                    })
                    .catch(err => {
                        notyf.open({ type: 'error', message: '‚ùå L·ªói k·∫øt n·ªëi t·ªõi Zalo TTS' });
                    });
            });
        });
    });
</script>



{% endblock javascripts %}